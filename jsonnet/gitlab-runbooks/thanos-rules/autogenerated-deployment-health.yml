# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/recording-rules.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Autogenerated Deployment Health Indicators
  interval: 1m
  partial_response_strategy: warn
  rules:
  - record: gitlab_deployment_health:service:errors
    expr: |
      clamp_max(
        (
          gitlab_service_errors:ratio_1h{monitor="global"}
          > bool on(type,tier) group_left()
          (
            14.4 * (
              avg by (type,tier) (slo:max:deployment:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        *
        (
          gitlab_service_errors:ratio_5m{monitor="global"}
          > bool on(type,tier) group_left()
          (
            14.4 * (
              avg by (type,tier) (slo:max:deployment:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        +
        (
          gitlab_service_errors:ratio_6h{monitor="global"}
          > bool on(type,tier) group_left()
          (
            6 * (
              avg by (type,tier) (slo:max:deployment:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        *
        (
          gitlab_service_errors:ratio_30m{monitor="global"}
          > bool on(type,tier) group_left()
          (
            6 * (
              avg by (type,tier) (slo:max:deployment:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        ),
        1
      ) == bool 0
  - record: gitlab_deployment_health:service:apdex
    expr: |
      clamp_max(
        (
          gitlab_service_apdex:ratio_1h{monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              14.4 * (1 - avg by (type,tier) (slo:min:deployment:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        *
        (
          gitlab_service_apdex:ratio_5m{monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              14.4 * (1 - avg by (type,tier) (slo:min:deployment:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        +
        (
          gitlab_service_apdex:ratio_6h{monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              6 * (1 - avg by (type,tier) (slo:min:deployment:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        *
        (
          gitlab_service_apdex:ratio_30m{monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              6 * (1 - avg by (type,tier) (slo:min:deployment:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        ),
        1
      ) == bool 0
  - record: gitlab_deployment_health:service
    expr: |
      min without (sli_type) (
        label_replace(gitlab_deployment_health:service:apdex{monitor="global"}, "sli_type", "apdex", "", "")
        or
        label_replace(gitlab_deployment_health:service:errors{monitor="global"}, "sli_type", "errors", "", "")
      )
  - record: gitlab_deployment_health:stage
    expr: |
      min by (environment, env, stage) (
        gitlab_deployment_health:service{monitor="global"}
      )
