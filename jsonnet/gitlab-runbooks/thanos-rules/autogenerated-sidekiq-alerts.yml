# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/sidekiq-queue-rules.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Sidekiq queue source metrics per worker (fast burn)
  interval: 1m
  partial_response_strategy: warn
  rules:
  - record: gitlab_background_jobs:queue:ops:rate_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:ops:rate_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:success:rate_5m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:weight:score_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:queue:ops:rate_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:ops:rate_1h{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:success:rate_1h{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:weight:score_1h{monitor!="global"} >= 0)
      )
- name: Sidekiq queue source metrics per worker (slow burn)
  interval: 2m
  partial_response_strategy: warn
  rules:
  - record: gitlab_background_jobs:queue:ops:rate_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:ops:rate_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:success:rate_30m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:queue:apdex:weight:score_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:queue:ops:rate_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:queue:ops:rate_1h{monitor!="global"}[6h])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:queue:apdex:success:rate_1h{monitor!="global"}[6h])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:queue:apdex:weight:score_1h{monitor!="global"}[6h])
      )
  - record: gitlab_background_jobs:queue:ops:rate_3d
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:queue:ops:rate_1h{monitor!="global"}[3d])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_3d
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:queue:apdex:success:rate_1h{monitor!="global"}[3d])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:queue:apdex:weight:score_1h{monitor!="global"}[3d])
      )
- name: Sidekiq execution source metrics per worker (fast burn)
  interval: 1m
  partial_response_strategy: warn
  rules:
  - record: gitlab_background_jobs:execution:error:rate_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:error:rate_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:ops:rate_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:ops:rate_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:error:ratio_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:error:rate_5m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:ops:rate_5m{monitor!="global"} >= 0)
        and
        (gitlab_background_jobs:execution:error:rate_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:weight:score_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_5m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:success:rate_5m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_5m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:error:rate_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:error:rate_1h{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:ops:rate_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:error:ratio_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:error:rate_1h{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"} >= 0)
        and
        (gitlab_background_jobs:execution:error:rate_1h{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:weight:score_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_1h{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_1h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:success:rate_1h{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_1h{monitor!="global"} >= 0)
      )
- name: Sidekiq execution source metrics per worker (slow burn)
  interval: 2m
  partial_response_strategy: warn
  rules:
  - record: gitlab_background_jobs:execution:error:rate_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:error:rate_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:ops:rate_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:ops:rate_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:error:ratio_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:error:rate_30m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)(
        (gitlab_background_jobs:execution:ops:rate_30m{monitor!="global"} >= 0)
        and
        (gitlab_background_jobs:execution:error:rate_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:weight:score_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_30m
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:success:rate_30m{monitor!="global"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        (gitlab_background_jobs:execution:apdex:weight:score_30m{monitor!="global"} >= 0)
      )
  - record: gitlab_background_jobs:execution:error:rate_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:execution:error:rate_1h{monitor!="global"}[6h])
      )
  - record: gitlab_background_jobs:execution:ops:rate_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"}[6h])
      )
  - record: gitlab_background_jobs:execution:error:ratio_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:error:rate_1h{monitor!="global"}[6h])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"}[6h])
        and
        gitlab_background_jobs:execution:error:rate_1h{monitor!="global"} >= 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:apdex:success:rate_1h{monitor!="global"}[6h])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:apdex:weight:score_1h{monitor!="global"}[6h])
      )
  - record: gitlab_background_jobs:execution:error:rate_6h
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:execution:error:rate_1h{monitor!="global"}[3d])
      )
  - record: gitlab_background_jobs:execution:ops:rate_3d
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        avg_over_time(gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"}[3d])
      )
  - record: gitlab_background_jobs:execution:error:ratio_3d
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:error:rate_1h{monitor!="global"}[3d])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"}[3d])
        and
        gitlab_background_jobs:execution:error:rate_1h{monitor!="global"} >= 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_3d
    expr: |
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:apdex:success:rate_1h{monitor!="global"}[3d])
      )
      /
      sum by (env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (
        sum_over_time(gitlab_background_jobs:execution:apdex:weight:score_1h{monitor!="global"}[3d])
      )
- name: Sidekiq Aggregated Thanos Alerts
  interval: 1m
  partial_response_strategy: warn
  rules:
  - alert: sidekiq_throttled_jobs_enqueued_without_dequeuing
    for: 30m
    annotations:
      title: Sidekiq jobs are being enqueued without being dequeued
      description: |
        The `{{ $labels.worker}}` worker in the {{ $labels.queue }} queue appears to have jobs being enqueued without those jobs being executed.

        This could be the result of a Sidekiq server configuration issue, where no Sidekiq servers are configured to dequeue the specific worker.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_variables: environment,stage,worker
      promql_template_1: sidekiq_enqueued_jobs_total{environment="$environment", type="$type",
        stage="$stage", component="$component"}
      runbook: docs/sidekiq/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s4
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (
        sum by (environment, queue, feature_category, worker) (
          gitlab_background_jobs:queue:ops:rate_1h{urgency="throttled"}
        ) > 0
      )
      unless
      (
        sum by (environment, queue, feature_category, worker) (
          gitlab_background_jobs:execution:ops:rate_1h{urgency="throttled"}
        ) > 0
      )
  - alert: SidekiqQueueNoLongerBeingProcessed
    for: 20m
    annotations:
      title: A Sidekiq queue is no longer being processed.
      description: Sidekiq queue {{ $labels.queue }} in shard {{ $labels.shard }}
        is no longer being processed.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-queue={{ $labels.queue
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3168042924"
      grafana_variables: environment,stage,queue
      promql_template_1: gitlab_background_jobs:execution:ops:rate_6h{environment="$environment",
        queue="$queue"}
      runbook: docs/sidekiq/sidekiq-queue-not-being-processed.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s3
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (sum by(environment, queue) (gitlab_background_jobs:queue:ops:rate_6h) > 0.001)
      unless
      (sum by(environment, queue) (gitlab_background_jobs:execution:ops:rate_6h)  > 0)
  - alert: SidekiqWorkerNoLongerBeingProcessed
    for: 20m
    annotations:
      title: A Sidekiq worker is no longer being processed.
      description: Sidekiq worker {{ $labels.worker }} in shard {{ $labels.shard }}
        is no longer being processed.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3168042924"
      grafana_variables: environment,stage,worker
      promql_template_1: gitlab_background_jobs:execution:ops:rate_6h{environment="$environment",
        worker="$worker"}
      runbook: docs/sidekiq/sidekiq-queue-not-being-processed.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s3
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (sum by(environment, worker) (gitlab_background_jobs:queue:ops:rate_6h) > 0.001)
      unless
      (sum by(environment, worker) (gitlab_background_jobs:execution:ops:rate_6h)  > 0)
  - alert: SidekiqServiceWorkerExecutionApdexSLOViolation
    for: 1h
    annotations:
      title: The `{{ $labels.worker }}` Sidekiq worker, `{{ $labels.stage }}` stage,
        has an apdex violating SLO
      description: |
        The `{{ $labels.worker }}` worker is not meeting its apdex SLO.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2504679775"
      grafana_variables: environment,stage,worker
      runbook: docs/sidekiq/README.md
    labels:
      aggregation: sidekiq_execution
      alert_class: slo_violation
      alert_type: symptom
      rules_domain: general
      severity: s4
      sli_type: apdex
      slo_alert: "yes"
      window: 3d
    expr: |
      (
        (
          gitlab_background_jobs:execution:apdex:ratio_3d{monitor="global"}
          < (1 - 1 * 0.100000)
        )
        and
        (
          gitlab_background_jobs:execution:apdex:ratio_6h{monitor="global"}
          < (1 - 1 * 0.100000)
        )
      )
      and on(env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)
      (
        sum by(env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (gitlab_background_jobs:execution:ops:rate_3d{monitor="global"}) >= 0.00463
      )
  - alert: SidekiqServiceWorkerExecutionErrorSLOViolation
    for: 1h
    annotations:
      title: The `{{ $labels.worker }}` Sidekiq worker, `{{ $labels.stage }}` stage,
        has an error rate violating SLO
      description: |
        The `{{ $labels.worker }}` worker is not meeting its error-rate SLO.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2383655193"
      grafana_variables: environment,stage,worker
      runbook: docs/sidekiq/README.md
    labels:
      aggregation: sidekiq_execution
      alert_class: slo_violation
      alert_type: symptom
      rules_domain: general
      severity: s4
      sli_type: error
      slo_alert: "yes"
      window: 3d
    expr: |
      (
        (
          gitlab_background_jobs:execution:error:ratio_3d{monitor="global"}
          > (1 * 0.100000)
        )
        and
        (
          gitlab_background_jobs:execution:error:ratio_6h{monitor="global"}
          > (1 * 0.100000)
        )
      )
      and on(env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker)
      (
        sum by(env,environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (gitlab_background_jobs:execution:ops:rate_3d{monitor="global"}) >= 1.15741e-05
      )
