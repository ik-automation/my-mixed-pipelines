# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/service-component-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 'Service Component Alerts: web-pages'
  interval: 1m
  partial_response_strategy: warn
  rules:
  - alert: WebPagesServiceLoadbalancerErrorSLOViolation
    for: 2m
    annotations:
      title: The loadbalancer SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has an error rate violating SLO
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3255520955"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_component_errors:ratio_1h{component="loadbalancer",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_5m{component="loadbalancer",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="loadbalancer",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceLoadbalancerErrorSLOViolation
    for: 2m
    annotations:
      title: The loadbalancer SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has an error rate violating SLO
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3255520955"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_component_errors:ratio_6h{component="loadbalancer",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_30m{component="loadbalancer",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_6h{component="loadbalancer",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceLoadbalancerErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The loadbalancer SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3255520955"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_1h{component="loadbalancer",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_5m{component="loadbalancer",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_1h{component="loadbalancer",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceLoadbalancerErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The loadbalancer SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3255520955"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_6h{component="loadbalancer",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_30m{component="loadbalancer",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_6h{component="loadbalancer",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceLoadbalancerTrafficCessation
    for: 5m
    annotations:
      title: The loadbalancer SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has not received any traffic in the past 30m
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "138982496"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_30m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_component_ops:rate_30m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceLoadbalancerTrafficAbsent
    for: 30m
    annotations:
      title: The loadbalancer SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has not reported any traffic in the past 30m
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "138982496"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_5m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_component_ops:rate_5m{component="loadbalancer",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceLoadbalancerTrafficCessationRegional
    for: 5m
    annotations:
      title: The loadbalancer SLI of the web-pages service in region `{{ $labels.region
        }}` has not received any traffic in the past 30m
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "138982496"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_30m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_regional_sli_ops:rate_30m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceLoadbalancerTrafficAbsentRegional
    for: 30m
    annotations:
      title: The loadbalancer SLI of the web-pages service in region `{{ $labels.region
        }}` has not reported any traffic in the past 30m
      description: |
        Measures aggregated HTTP request traffic through the HAProxy. 5xx responses are considered to be failures.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "138982496"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_5m{component="loadbalancer",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_regional_sli_ops:rate_5m{component="loadbalancer",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceLoadbalancerHttpsErrorSLOViolation
    for: 2m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service (`{{ $labels.stage
        }}` stage) has an error rate violating SLO
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2962826191"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_component_errors:ratio_1h{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_5m{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="loadbalancer_https",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceLoadbalancerHttpsErrorSLOViolation
    for: 2m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service (`{{ $labels.stage
        }}` stage) has an error rate violating SLO
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2962826191"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_component_errors:ratio_6h{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_30m{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_6h{component="loadbalancer_https",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceLoadbalancerHttpsErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2962826191"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_1h{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_5m{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_1h{component="loadbalancer_https",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceLoadbalancerHttpsErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2962826191"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_6h{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_30m{component="loadbalancer_https",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_6h{component="loadbalancer_https",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceLoadbalancerHttpsTrafficCessation
    for: 5m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service (`{{ $labels.stage
        }}` stage) has not received any traffic in the past 30m
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2234251543"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_30m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_component_ops:rate_30m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceLoadbalancerHttpsTrafficAbsent
    for: 30m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service (`{{ $labels.stage
        }}` stage) has not reported any traffic in the past 30m
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2234251543"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_5m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_component_ops:rate_5m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceLoadbalancerHttpsTrafficCessationRegional
    for: 5m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service in region `{{ $labels.region
        }}` has not received any traffic in the past 30m
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2234251543"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_30m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_regional_sli_ops:rate_30m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceLoadbalancerHttpsTrafficAbsentRegional
    for: 30m
    annotations:
      title: The loadbalancer_https SLI of the web-pages service in region `{{ $labels.region
        }}` has not reported any traffic in the past 30m
      description: |
        Measures aggregated L4 traffic through the HAProxy. Traffic is measured in TCP connections, with upstream TCP connection failures being treated as service-level failures.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2234251543"
      grafana_variables: environment,stage
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_5m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_regional_sli_ops:rate_5m{component="loadbalancer_https",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceServerApdexSLOViolation
    for: 2m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has an apdex violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2863319079"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,le) (
            rate(gitlab_pages_http_request_duration_seconds_bucket{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_component_apdex:ratio_1h{component="server",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_5m{component="server",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="server",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerApdexSLOViolation
    for: 2m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has an apdex violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2863319079"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,le) (
            rate(gitlab_pages_http_request_duration_seconds_bucket{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_component_apdex:ratio_6h{component="server",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_30m{component="server",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_6h{component="server",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerApdexSLOViolationRegional
    for: 2m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has an apdex violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2863319079"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,region,le) (
            rate(gitlab_pages_http_request_duration_seconds_bucket{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_regional_sli_apdex:ratio_1h{component="server",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
        and
        (
          gitlab_regional_sli_apdex:ratio_5m{component="server",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_1h{component="server",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerApdexSLOViolationRegional
    for: 2m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has an apdex violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2863319079"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,region,le) (
            rate(gitlab_pages_http_request_duration_seconds_bucket{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_regional_sli_apdex:ratio_6h{component="server",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
        and
        (
          gitlab_regional_sli_apdex:ratio_30m{component="server",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_6h{component="server",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerErrorSLOViolation
    for: 2m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has an error rate violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "1631973137"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_requests_total{code=~"5..",environment="{{ $labels.environment }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_component_errors:ratio_1h{component="server",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_5m{component="server",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="server",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerErrorSLOViolation
    for: 2m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has an error rate violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "1631973137"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_requests_total{code=~"5..",environment="{{ $labels.environment }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_component_errors:ratio_6h{component="server",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_30m{component="server",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_6h{component="server",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "1631973137"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_requests_total{code=~"5..",environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_1h{component="server",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_5m{component="server",monitor="global",type="web-pages"}
          > (14.4 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_1h{component="server",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerErrorSLOViolationRegional
    for: 2m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has an error rate violating SLO
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "1631973137"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_requests_total{code=~"5..",environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: error
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_regional_sli_errors:ratio_6h{component="server",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_regional_sli_errors:ratio_30m{component="server",monitor="global",type="web-pages"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_6h{component="server",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerTrafficCessation
    for: 5m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has not received any traffic in the past 30m
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2414183688"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_requests_total{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_30m{component="server",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_component_ops:rate_30m{component="server",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceServerTrafficAbsent
    for: 30m
    annotations:
      title: The server SLI of the web-pages service (`{{ $labels.stage }}` stage)
        has not reported any traffic in the past 30m
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2414183688"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_requests_total{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_5m{component="server",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_component_ops:rate_5m{component="server",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceServerTrafficCessationRegional
    for: 5m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has not received any traffic in the past 30m
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2414183688"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_requests_total{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_30m{component="server",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_regional_sli_ops:rate_30m{component="server",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceServerTrafficAbsentRegional
    for: 30m
    annotations:
      title: The server SLI of the web-pages service in region `{{ $labels.region
        }}` has not reported any traffic in the past 30m
      description: |
        Aggregation of most web requests into the GitLab Pages process.

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2414183688"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_requests_total{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_5m{component="server",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_regional_sli_ops:rate_5m{component="server",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceServerHeadersApdexSLOViolation
    for: 2m
    annotations:
      title: The server_headers SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has an apdex violating SLO
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2237799391"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,le) (
            rate(gitlab_pages_http_time_to_write_header_seconds_bucket{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_component_apdex:ratio_1h{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_5m{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="server_headers",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerHeadersApdexSLOViolation
    for: 2m
    annotations:
      title: The server_headers SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has an apdex violating SLO
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2237799391"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,le) (
            rate(gitlab_pages_http_time_to_write_header_seconds_bucket{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_component_apdex:ratio_6h{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_30m{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_6h{component="server_headers",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerHeadersApdexSLOViolationRegional
    for: 2m
    annotations:
      title: The server_headers SLI of the web-pages service in region `{{ $labels.region
        }}` has an apdex violating SLO
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2237799391"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,region,le) (
            rate(gitlab_pages_http_time_to_write_header_seconds_bucket{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 1h
    expr: |
      (
        (
          gitlab_regional_sli_apdex:ratio_1h{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
        and
        (
          gitlab_regional_sli_apdex:ratio_5m{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 14.4 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_1h{component="server_headers",monitor="global",type="web-pages"}) >= 1
      )
  - alert: WebPagesServiceServerHeadersApdexSLOViolationRegional
    for: 2m
    annotations:
      title: The server_headers SLI of the web-pages service in region `{{ $labels.region
        }}` has an apdex violating SLO
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        Note that this alert is specific to the `{{ $labels.region }}` region.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2237799391"
      grafana_variables: environment,stage
      promql_template_1: |
        histogram_quantile(
          0.950000,
          sum by (env,environment,tier,stage,region,le) (
            rate(gitlab_pages_http_time_to_write_header_seconds_bucket{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
          )
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: slo_violation
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: apdex
      slo_alert: "yes"
      user_impacting: "yes"
      window: 6h
    expr: |
      (
        (
          gitlab_regional_sli_apdex:ratio_6h{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
        and
        (
          gitlab_regional_sli_apdex:ratio_30m{component="server_headers",monitor="global",type="web-pages"}
          < (1 - 6 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,region,component)
      (
        sum by(env,environment,tier,type,stage,region,component) (gitlab_regional_sli_ops:rate_6h{component="server_headers",monitor="global",type="web-pages"}) >= 0.16667
      )
  - alert: WebPagesServiceServerHeadersTrafficCessation
    for: 5m
    annotations:
      title: The server_headers SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has not received any traffic in the past 30m
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3686204985"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_time_to_write_header_seconds_count{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_30m{component="server_headers",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_component_ops:rate_30m{component="server_headers",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceServerHeadersTrafficAbsent
    for: 30m
    annotations:
      title: The server_headers SLI of the web-pages service (`{{ $labels.stage }}`
        stage) has not reported any traffic in the past 30m
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3686204985"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage) (
          rate(gitlab_pages_http_time_to_write_header_seconds_count{environment="{{ $labels.environment }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_component_ops:rate_5m{component="server_headers",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_component_ops:rate_5m{component="server_headers",monitor="global",stage="main",type="web-pages"}
  - alert: WebPagesServiceServerHeadersTrafficCessationRegional
    for: 5m
    annotations:
      title: The server_headers SLI of the web-pages service in region `{{ $labels.region
        }}` has not received any traffic in the past 30m
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        This alert signifies that the SLI is reporting a cessation of traffic; the signal is present, but is zero.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3686204985"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_time_to_write_header_seconds_count{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_30m{component="server_headers",monitor="global",stage="main",type="web-pages"} == 0
      and
      gitlab_regional_sli_ops:rate_30m{component="server_headers",monitor="global",stage="main",type="web-pages"} offset 1h >= 0.16666666666666666
  - alert: WebPagesServiceServerHeadersTrafficAbsentRegional
    for: 30m
    annotations:
      title: The server_headers SLI of the web-pages service in region `{{ $labels.region
        }}` has not reported any traffic in the past 30m
      description: |
        Response time can be slow due to large files served by pages. This SLI tracks only time needed to finish writing headers. It includes API requests to GitLab instance, scanning ZIP archive for file entries, processing redirects, etc. We use it as stricter SLI for pages as it's independent of served file size

        This alert signifies that the SLI was previously reporting traffic, but is no longer - the signal is absent.

        This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.

        Note that this alert is specific to the `{{ $labels.region }}` region.
      grafana_dashboard_id: web-pages-main/web-pages-overview
      grafana_dashboard_link: https://dashboards.gitlab.net/d/web-pages-main/web-pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3686204985"
      grafana_variables: environment,stage
      promql_template_1: |
        sum by (env,environment,tier,stage,region) (
          rate(gitlab_pages_http_time_to_write_header_seconds_count{environment="{{ $labels.environment }}",region="{{ $labels.region }}",stage="{{ $labels.stage }}",type="web-pages"}[5m])
        )
      runbook: docs/web-pages/README.md
    labels:
      aggregation: regional_component
      alert_class: traffic_cessation
      alert_type: cause
      feature_category: pages
      pager: pagerduty
      rules_domain: general
      severity: s2
      sli_type: ops
      slo_alert: "no"
      user_impacting: "yes"
    expr: |
      gitlab_regional_sli_ops:rate_5m{component="server_headers",monitor="global",stage="main",type="web-pages"} offset 1h
      unless
      gitlab_regional_sli_ops:rate_5m{component="server_headers",monitor="global",stage="main",type="web-pages"}
