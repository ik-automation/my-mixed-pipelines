---

# Generated by "make generate-ci-config"
# Do not edit!!

assert_formatting:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - if: $TANKA_DEPLOYMENTS_RUN == "1" || $TANKA_DEPLOYMENTS_RUN == null
  script: |
    find . -name '*.*sonnet' | xargs -n1 jsonnetfmt -i
    git diff --exit-code
  stage: checks
build_ci_docker_image:
  image: docker:stable
  rules:
    - changes:
        - Dockerfile
        - .tool-versions
        - bin/install_tools
      if: $CI_COMMIT_BRANCH == "master" && ($TANKA_DEPLOYMENTS_RUN == "1" || $TANKA_DEPLOYMENTS_RUN == null)
    - if: $BUILD_CI_IMAGE == "1"
  script: |
    docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    tag="${CI_REGISTRY_IMAGE}/ci:latest"
    docker build -t "${tag}" .
    docker push "${tag}"
  services:
    - docker:dind
  stage: build_ci_image
ci_config_generated:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - if: $TANKA_DEPLOYMENTS_RUN == "1" || $TANKA_DEPLOYMENTS_RUN == null
  script: |
    make generate-ci-config
    git diff --exit-code || (echo "Please run 'make generate-ci-config'" >&2 && exit 1)
  stage: checks
delivery-metrics:ops:apply:
  environment: delivery-metrics/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - delivery-metrics:ops:diff
  resource_group: delivery-metrics/ops
  rules:
    - changes:
        - environments/delivery-metrics/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "delivery-metrics/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/delivery-metrics --name delivery-metrics/ops --tla-str tag="${DELIVERY_METRICS_TAG}" | colordiff
    tk prune --dangerous-auto-approve environments/delivery-metrics --name delivery-metrics/ops --tla-str tag="${DELIVERY_METRICS_TAG}" | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    DELIVERY_METRICS_TAG: latest
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
delivery-metrics:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/delivery-metrics/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "delivery-metrics/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/delivery-metrics --name delivery-metrics/ops --tla-str tag="${DELIVERY_METRICS_TAG}" | colordiff
    echo -e "\033[0;31m!!! Attention !!!
    This environment is often applied via API-triggered pipelines that override
    the image tag. If you're seeing a diff in that field, that's probably why. It
    should be safe to deploy the "latest" tag, due to ImagePullPolicy=Always.
    !!! Attention !!!
    \033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    DELIVERY_METRICS_TAG: latest
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
dependency_scanning:
  stage: checks
elastic:gstg:apply:
  environment: elastic/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - elastic:gstg:diff
  resource_group: elastic/gstg
  rules:
    - changes:
        - environments/elastic/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "elastic/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/elastic --name elastic/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/elastic --name elastic/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
elastic:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/elastic/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "elastic/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/elastic --name elastic/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
ensure_vendored_charts:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - if: $TANKA_DEPLOYMENTS_RUN == "1" || $TANKA_DEPLOYMENTS_RUN == null
  script: |
    make ensure-vendored-charts
  stage: checks
evicted-pod-reaper:gprd:apply:
  environment: evicted-pod-reaper/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - evicted-pod-reaper:gprd:diff
  resource_group: evicted-pod-reaper/gprd
  rules:
    - changes:
        - environments/evicted-pod-reaper/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "evicted-pod-reaper/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/evicted-pod-reaper --name evicted-pod-reaper/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/evicted-pod-reaper --name evicted-pod-reaper/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
evicted-pod-reaper:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/evicted-pod-reaper/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "evicted-pod-reaper/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/evicted-pod-reaper --name evicted-pod-reaper/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
fluentd-archiver:gprd:apply:
  environment: fluentd-archiver/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-archiver:gprd:diff
  resource_group: fluentd-archiver/gprd
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
fluentd-archiver:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-archiver --name fluentd-archiver/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
fluentd-archiver:gstg:apply:
  environment: fluentd-archiver/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-archiver:gstg:diff
  resource_group: fluentd-archiver/gstg
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
fluentd-archiver:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-archiver --name fluentd-archiver/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
fluentd-archiver:ops:apply:
  environment: fluentd-archiver/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-archiver:ops:diff
  resource_group: fluentd-archiver/ops
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/ops  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/ops  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
fluentd-archiver:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-archiver --name fluentd-archiver/ops  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
fluentd-archiver:pre:apply:
  environment: fluentd-archiver/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-archiver:pre:diff
  resource_group: fluentd-archiver/pre
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/pre  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-archiver --name fluentd-archiver/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
fluentd-archiver:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-archiver/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-archiver/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-archiver --name fluentd-archiver/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:gprd-us-east1-b:apply:
  environment: fluentd-elasticsearch/gprd-us-east1-b
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gprd-us-east1-b:diff
  resource_group: fluentd-elasticsearch/gprd-us-east1-b
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-b"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-b  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-b  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-b
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-b
fluentd-elasticsearch:gprd-us-east1-b:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-b"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-b  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-b
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-b
fluentd-elasticsearch:gprd-us-east1-c:apply:
  environment: fluentd-elasticsearch/gprd-us-east1-c
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gprd-us-east1-c:diff
  resource_group: fluentd-elasticsearch/gprd-us-east1-c
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-c"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-c  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-c  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-c
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-c
fluentd-elasticsearch:gprd-us-east1-c:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-c"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-c  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-c
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-c
fluentd-elasticsearch:gprd-us-east1-d:apply:
  environment: fluentd-elasticsearch/gprd-us-east1-d
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gprd-us-east1-d:diff
  resource_group: fluentd-elasticsearch/gprd-us-east1-d
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-d"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-d  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-d  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-d
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-d
fluentd-elasticsearch:gprd-us-east1-d:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd-us-east1-d"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd-us-east1-d  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-us-east1-d
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_ZONE: us-east1-d
fluentd-elasticsearch:gprd:apply:
  environment: fluentd-elasticsearch/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gprd:diff
  resource_group: fluentd-elasticsearch/gprd
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:gstg-us-east1-b:apply:
  environment: fluentd-elasticsearch/gstg-us-east1-b
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gstg-us-east1-b:diff
  resource_group: fluentd-elasticsearch/gstg-us-east1-b
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-b"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-b  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-b  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-b
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-b
fluentd-elasticsearch:gstg-us-east1-b:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-b"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-b  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-b
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-b
fluentd-elasticsearch:gstg-us-east1-c:apply:
  environment: fluentd-elasticsearch/gstg-us-east1-c
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gstg-us-east1-c:diff
  resource_group: fluentd-elasticsearch/gstg-us-east1-c
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-c"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-c  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-c  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-c
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-c
fluentd-elasticsearch:gstg-us-east1-c:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-c"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-c  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-c
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-c
fluentd-elasticsearch:gstg-us-east1-d:apply:
  environment: fluentd-elasticsearch/gstg-us-east1-d
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gstg-us-east1-d:diff
  resource_group: fluentd-elasticsearch/gstg-us-east1-d
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-d"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-d  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-d  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-d
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-d
fluentd-elasticsearch:gstg-us-east1-d:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg-us-east1-d"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg-us-east1-d  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-us-east1-d
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_ZONE: us-east1-d
fluentd-elasticsearch:gstg:apply:
  environment: fluentd-elasticsearch/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:gstg:diff
  resource_group: fluentd-elasticsearch/gstg
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:ops:apply:
  environment: fluentd-elasticsearch/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:ops:diff
  resource_group: fluentd-elasticsearch/ops
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/ops  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/ops  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/ops  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:pre:apply:
  environment: fluentd-elasticsearch/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - fluentd-elasticsearch:pre:diff
  resource_group: fluentd-elasticsearch/pre
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/pre  | colordiff
    tk prune --dangerous-auto-approve environments/fluentd-elasticsearch --name fluentd-elasticsearch/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
fluentd-elasticsearch:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/fluentd-elasticsearch/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "fluentd-elasticsearch/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/fluentd-elasticsearch --name fluentd-elasticsearch/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
gcp-quota-exporter:gprd:apply:
  environment: gcp-quota-exporter/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - gcp-quota-exporter:gprd:diff
  resource_group: gcp-quota-exporter/gprd
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
gcp-quota-exporter:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/gcp-quota-exporter --name gcp-quota-exporter/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
gcp-quota-exporter:gstg:apply:
  environment: gcp-quota-exporter/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - gcp-quota-exporter:gstg:diff
  resource_group: gcp-quota-exporter/gstg
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
gcp-quota-exporter:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/gcp-quota-exporter --name gcp-quota-exporter/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
gcp-quota-exporter:ops:apply:
  environment: gcp-quota-exporter/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - gcp-quota-exporter:ops:diff
  resource_group: gcp-quota-exporter/ops
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/ops  | colordiff
    tk prune --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/ops  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
gcp-quota-exporter:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/gcp-quota-exporter --name gcp-quota-exporter/ops  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
gcp-quota-exporter:pre:apply:
  environment: gcp-quota-exporter/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - gcp-quota-exporter:pre:diff
  resource_group: gcp-quota-exporter/pre
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/pre  | colordiff
    tk prune --dangerous-auto-approve environments/gcp-quota-exporter --name gcp-quota-exporter/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
gcp-quota-exporter:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/gcp-quota-exporter/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "gcp-quota-exporter/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/gcp-quota-exporter --name gcp-quota-exporter/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
grafana:ops:apply:
  environment: grafana/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - grafana:ops:diff
  resource_group: grafana/ops
  rules:
    - changes:
        - environments/grafana/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "grafana/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/grafana --name grafana/ops  | colordiff
    tk prune --dangerous-auto-approve environments/grafana --name grafana/ops  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
grafana:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/grafana/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "grafana/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/grafana --name grafana/ops  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
grafana:pre:apply:
  environment: grafana/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - grafana:pre:diff
  resource_group: grafana/pre
  rules:
    - changes:
        - environments/grafana/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "grafana/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/grafana --name grafana/pre  | colordiff
    tk prune --dangerous-auto-approve environments/grafana --name grafana/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
grafana:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/grafana/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "grafana/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/grafana --name grafana/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml
notify_mirror_source:
  image: registry.gitlab.com/gitlab-com/gl-infra/woodhouse:latest
  rules:
    - if: $TANKA_DEPLOYMENTS_RUN == "1"
  script: woodhouse gitlab notify-mirrored-mr
  stage: notify
plantuml:gprd:apply:
  environment: plantuml/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - plantuml:gprd:diff
  resource_group: plantuml/gprd
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/plantuml --name plantuml/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/plantuml --name plantuml/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
plantuml:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/plantuml --name plantuml/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
plantuml:gstg:apply:
  environment: plantuml/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - plantuml:gstg:diff
  resource_group: plantuml/gstg
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/plantuml --name plantuml/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/plantuml --name plantuml/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
plantuml:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/plantuml --name plantuml/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
plantuml:pre:apply:
  environment: plantuml/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - plantuml:pre:diff
  resource_group: plantuml/pre
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/plantuml --name plantuml/pre  | colordiff
    tk prune --dangerous-auto-approve environments/plantuml --name plantuml/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
plantuml:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/plantuml/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "plantuml/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/plantuml --name plantuml/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
redis:gstg:apply:
  environment: redis/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - redis:gstg:diff
  resource_group: redis/gstg
  rules:
    - changes:
        - environments/redis/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "redis/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/redis --name redis/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/redis --name redis/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
redis:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/redis/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "redis/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/redis --name redis/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
redis:pre:apply:
  environment: redis/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - redis:pre:diff
  resource_group: redis/pre
  rules:
    - changes:
        - environments/redis/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "redis/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/redis --name redis/pre  | colordiff
    tk prune --dangerous-auto-approve environments/redis --name redis/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
redis:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/redis/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "redis/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/redis --name redis/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
stages:
  - notify
  - build_ci_image
  - checks
  - diff
  - apply
thanos:gprd:apply:
  environment: thanos/gprd
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:gprd:diff
  resource_group: thanos/gprd
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/gprd"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/gprd  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/gprd  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
thanos:gprd:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/gprd"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/gprd  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gprd
    GKE_CLUSTER: gprd-gitlab-gke
    GOOGLE_PROJECT: gitlab-production
    GOOGLE_REGION: us-east1
thanos:gstg:apply:
  environment: thanos/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:gstg:diff
  resource_group: thanos/gstg
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/gstg  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/gstg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
thanos:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/gstg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
thanos:ops-stg:apply:
  environment: thanos/ops-stg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:ops-stg:diff
  resource_group: thanos/ops-stg
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/ops-stg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/ops-stg  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/ops-stg  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
thanos:ops-stg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/ops-stg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/ops-stg  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
thanos:ops:apply:
  environment: thanos/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:ops:diff
  resource_group: thanos/ops
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/ops  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/ops  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
thanos:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/ops  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
thanos:prdsub:apply:
  environment: thanos/prdsub
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:prdsub:diff
  resource_group: thanos/prdsub
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/prdsub"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/prdsub  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/prdsub  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: prdsub
    GKE_CLUSTER: prdsub-customers-gke
    GOOGLE_PROJECT: gitlab-subscriptions-prod
    GOOGLE_REGION: us-east1
thanos:prdsub:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/prdsub"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/prdsub  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: prdsub
    GKE_CLUSTER: prdsub-customers-gke
    GOOGLE_PROJECT: gitlab-subscriptions-prod
    GOOGLE_REGION: us-east1
thanos:pre:apply:
  environment: thanos/pre
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:pre:diff
  resource_group: thanos/pre
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/pre"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/pre  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/pre  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
thanos:pre:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/pre"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/pre  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: pre
    GKE_CLUSTER: pre-gitlab-gke
    GOOGLE_PROJECT: gitlab-pre
    GOOGLE_REGION: us-east1
thanos:stgsub:apply:
  environment: thanos/stgsub
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - thanos:stgsub:diff
  resource_group: thanos/stgsub
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/stgsub"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/thanos --name thanos/stgsub  | colordiff
    tk prune --dangerous-auto-approve environments/thanos --name thanos/stgsub  | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: stgsub
    GKE_CLUSTER: stgsub-customers-gke
    GOOGLE_PROJECT: gitlab-subscriptions-staging
    GOOGLE_REGION: us-east1
thanos:stgsub:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/thanos/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "thanos/stgsub"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/thanos --name thanos/stgsub  | colordiff
    echo -e "\033[0;31m\033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: stgsub
    GKE_CLUSTER: stgsub-customers-gke
    GOOGLE_PROJECT: gitlab-subscriptions-staging
    GOOGLE_REGION: us-east1
variables:
  VAULT_AUTH_PATH: ops-gitlab-net
  VAULT_AUTH_ROLE: tanka-deployments
  VAULT_SERVER_URL: https://vault.ops.gke.gitlab.net
woodhouse:gstg:apply:
  environment: woodhouse/gstg
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - woodhouse:gstg:diff
  resource_group: woodhouse/gstg
  rules:
    - changes:
        - environments/woodhouse/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "woodhouse/gstg"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/woodhouse --name woodhouse/gstg --tla-str tag="${WOODHOUSE_TAG}" | colordiff
    tk prune --dangerous-auto-approve environments/woodhouse --name woodhouse/gstg --tla-str tag="${WOODHOUSE_TAG}" | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
    WOODHOUSE_TAG: latest
woodhouse:gstg:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/woodhouse/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "woodhouse/gstg"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/woodhouse --name woodhouse/gstg --tla-str tag="${WOODHOUSE_TAG}" | colordiff
    echo -e "\033[0;31m!!! Attention !!!
    This environment is often applied via API-triggered pipelines that override
    the image tag. If you're seeing a diff in that field, that's probably why. It
    should be safe to deploy the "latest" tag, due to ImagePullPolicy=Always.
    !!! Attention !!!
    \033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: gstg
    GKE_CLUSTER: gstg-gitlab-gke
    GOOGLE_PROJECT: gitlab-staging-1
    GOOGLE_REGION: us-east1
    WOODHOUSE_TAG: latest
woodhouse:ops:apply:
  environment: woodhouse/ops
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  needs:
    - woodhouse:ops:diff
  resource_group: woodhouse/ops
  rules:
    - changes:
        - environments/woodhouse/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1" && $CI_COMMIT_BRANCH == "master"
    - if: $TANKA_DEPLOYMENTS_RUN == "woodhouse/ops"
  script: |
    ./bin/kubectl_login
    make vendor
    tk apply --dangerous-auto-approve environments/woodhouse --name woodhouse/ops --tla-str tag="${WOODHOUSE_TAG}" | colordiff
    tk prune --dangerous-auto-approve environments/woodhouse --name woodhouse/ops --tla-str tag="${WOODHOUSE_TAG}" | colordiff
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: apply
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
    WOODHOUSE_TAG: latest
woodhouse:ops:diff:
  image: ${CI_REGISTRY_IMAGE}/ci:latest
  rules:
    - changes:
        - environments/woodhouse/*
        - lib/**/*
        - jsonnetfile.*
        - .gitlab-ci.yml
        - Dockerfile
        - charts/**/*
      if: $TANKA_DEPLOYMENTS_RUN == "1"
    - if: $TANKA_DEPLOYMENTS_RUN == "woodhouse/ops"
  script: |
    ./bin/kubectl_login
    make vendor

    tk diff --diff-strategy validate --with-prune --exit-zero environments/woodhouse --name woodhouse/ops --tla-str tag="${WOODHOUSE_TAG}" | colordiff
    echo -e "\033[0;31m!!! Attention !!!
    This environment is often applied via API-triggered pipelines that override
    the image tag. If you're seeing a diff in that field, that's probably why. It
    should be safe to deploy the "latest" tag, due to ImagePullPolicy=Always.
    !!! Attention !!!
    \033[0m"
  secrets:
    GOOGLE_APPLICATION_CREDENTIALS:
      file: true
      vault: ops-gitlab-net/tanka-deployments/shared/google-credentials/${ENVIRONMENT}/key@ci
  stage: diff
  tags:
    - k8s-workloads
  variables:
    ENVIRONMENT: ops
    GKE_CLUSTER: ops-gitlab-gke
    GOOGLE_PROJECT: gitlab-ops
    GOOGLE_REGION: us-east1
    WOODHOUSE_TAG: latest
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - when: always
